name: Deploy to Staging

on:
  push:
    branches:
      - staging

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install root dependencies
        run: npm ci
      
      - name: Install functions dependencies
        run: |
          cd functions
          npm ci
          cd ..
      
      # Create functions/.env from GitHub secrets
      - name: Create functions .env file
        run: |
          echo "Creating functions/.env from GitHub secrets..."
          cd functions
          echo "# Auto-generated from GitHub Secrets" > .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "‚úÖ Environment file created"
      
      - name: Build functions
        run: |
          cd functions
          npm run build
          cd ..
        env:
          NODE_ENV: development
      
      - name: Setup Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Authenticate with Firebase
        run: |
          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "‚ùå FIREBASE_TOKEN secret is not set. Please add it to GitHub Secrets."
            echo "To generate a token, run: firebase login:ci"
            exit 1
          fi
          echo "‚úÖ Firebase token is set (length: ${#FIREBASE_TOKEN})"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      # Deploy staging functions (dev- prefixed)
      - name: Deploy Firebase Functions (Staging - dev functions only)
        run: |
          cd functions
          npm run deploy:staging-functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NODE_ENV: development
      
      - name: Enable Firebase Web Frameworks experiment
        run: |
          firebase use choicestory-b3135 --token "$FIREBASE_TOKEN"
          firebase experiments:enable webframeworks --token "$FIREBASE_TOKEN" || echo "‚ö†Ô∏è  Experiment may already be enabled"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      # Create root .env for Next.js build (if needed by hosting)
      - name: Create root .env for Next.js
        run: |
          echo "Creating root .env for Next.js build..."
          if [ -n "${{ env.NEXT_PUBLIC_FIREBASE_API_KEY }}" ]; then
            echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ env.NEXT_PUBLIC_FIREBASE_API_KEY }}" > .env.production
            echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" >> .env.production
            echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" >> .env.production
            echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" >> .env.production
            echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" >> .env.production
            echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ env.NEXT_PUBLIC_FIREBASE_APP_ID }}" >> .env.production
            echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}" >> .env.production
            echo "NEXT_PUBLIC_FIREBASE_ENV=development" >> .env.production
            echo "‚úÖ Root environment file created"
          else
            echo "‚ö†Ô∏è  No Firebase config secrets found, skipping .env.production creation"
          fi
      
      # Clean previous build to ensure fresh build
      - name: Clean previous build artifacts
        run: |
          echo "üßπ Cleaning previous build artifacts..."
          rm -rf .next
          echo "‚úÖ Clean complete"
      
      # Build Next.js app for staging
      - name: Build Next.js app for staging
        run: |
          echo "üî® Building Next.js app for staging..."
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_FIREBASE_ENV: development
          FIREBASE_ENV: development
      
      - name: Deploy to Staging Hosting
        run: |
          echo "üîß Setting Firebase project..."
          firebase use choicestory-b3135 --token "$FIREBASE_TOKEN"
          echo "üîß Applying staging hosting target mapping..."
          firebase target:apply hosting staging choicestory-b3135-stage --token "$FIREBASE_TOKEN" || echo "‚ö†Ô∏è  Target may already be configured"
          echo "üì¶ Deploying to staging hosting (site: choicestory-b3135-stage)..."
          firebase deploy --only hosting:staging --token "$FIREBASE_TOKEN"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          NODE_ENV: production
          NEXT_PUBLIC_FIREBASE_ENV: development

