name: Deploy to Staging

on:
  push:
    branches:
      - staging

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install root dependencies
        run: npm ci
      
      - name: Install functions dependencies
        run: |
          cd functions
          npm ci
          cd ..
      
      # Create functions/.env from GitHub secrets
      - name: Create functions .env file
        run: |
          echo "Creating functions/.env from GitHub secrets..."
          cd functions
          echo "# Auto-generated from GitHub Secrets" > .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}" >> .env
          echo "âœ… Environment file created"
      
      - name: Build functions
        run: |
          cd functions
          npm run build
          cd ..
        env:
          NODE_ENV: development
      
      - name: Setup Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Authenticate with Firebase
        run: |
          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "âŒ FIREBASE_TOKEN secret is not set. Please add it to GitHub Secrets."
            echo "To generate a token, run: firebase login:ci"
            exit 1
          fi
          echo "âœ… Firebase token is set (length: ${#FIREBASE_TOKEN})"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      # Deploy staging functions (dev- prefixed)
      - name: Deploy Firebase Functions (Staging - dev functions only)
        run: |
          cd functions
          npm run deploy:staging-functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NODE_ENV: development
      
      - name: Enable Firebase Web Frameworks experiment
        run: |
          firebase use choicestory-b3135 --token "$FIREBASE_TOKEN"
          firebase experiments:enable webframeworks --token "$FIREBASE_TOKEN" || echo "âš ï¸  Experiment may already be enabled"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      
      # Create environment files for Next.js runtime and build
      - name: Create environment files for Next.js
        run: |
          echo "ðŸ” Creating environment files for Next.js..."
          
          # Create .env for runtime (will be deployed with the app)
          cat > .env << ENV_EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
          NEXT_PUBLIC_APP_ENV=development
          APP_ENV=development
          ENV_EOF
          
          # Create .env.production for build time
          cp .env .env.production
          
          echo "âœ… Environment files created (.env and .env.production)"
      
      # Clean previous build to ensure fresh build
      - name: Clean previous build artifacts
        run: |
          echo "ðŸ§¹ Cleaning previous build artifacts..."
          rm -rf .next
          echo "âœ… Clean complete"
      
      # Build Next.js app for staging
      - name: Build Next.js app for staging
        run: |
          echo "ðŸ”¨ Building Next.js app for staging..."
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_ENV: development
          APP_ENV: development
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      
      - name: Deploy to Staging Hosting
        run: |
          echo "ðŸ”§ Setting Firebase project..."
          firebase use choicestory-b3135 --token "$FIREBASE_TOKEN"
          echo "ðŸ”§ Applying staging hosting target mapping..."
          firebase target:apply hosting staging choicestory-b3135-stage --token "$FIREBASE_TOKEN" || echo "âš ï¸  Target may already be configured"
          echo "ðŸ“¦ Deploying to staging hosting (site: choicestory-b3135-stage)..."
          firebase deploy --only hosting:staging --token "$FIREBASE_TOKEN"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          NODE_ENV: production
          NEXT_PUBLIC_APP_ENV: development
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

